---
title: "Vasaloppet - Mellantidsrekommendationer"
author: "Olof Rännbäck Garpinger, Knightec AB, olof.rannbackgarpinger@knightec.se,"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::github_document:
    fig_width: 9
    fig_height: 5.562
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r libraries, message = F}
library(tidyverse)
library(lubridate)
library(directlabels)
```

```{r functions, message = F}
secs_to_time <- function(x){
  if (!is.na(x)) {
    require(lubridate)
    hh = (x %/% 3600)
    mm = (x %% 3600) %/% 60
    ss = (x %% 3600) %% 60
    hh = ifelse(hh<10, paste0(0,hh), as.character(hh))
    mm = ifelse(mm<10, paste0(0,mm), as.character(mm))
    ss = ifelse(ss<10, paste0(0,ss), as.character(ss))
    y = parse_time(paste0(hh,":",mm,":",ss))
    return(y)
  } else {
    return(NA)
  }
}

avg_paces_and_ranks <- function(tb, year){
  require(tidyverse) 
  tb %>% 
    group_by() %>% 
    summarize(smagan = mean(smagan_pace, na.rm = T),
              mangsbodarna = mean(mangsbodarna_pace, na.rm = T),
              risberg = mean(risberg_pace, na.rm = T),
              evertsberg = mean(evertsberg_pace, na.rm = T),
              oxberg = mean(oxberg_pace, na.rm = T),
              hokberg = mean(hokberg_pace, na.rm = T),
              eldris = mean(eldris_pace, na.rm = T),
              mora = mean(mora_pace, na.rm = T)) %>% 
    mutate(event_year = year) %>% 
    select(event_year, everything()) %>% 
    gather(smagan:mora, key = "checkpoint", value = "pace") %>% 
    filter(!is.na(checkpoint)) %>% 
    mutate(checkpoint_ranks = min_rank(-pace))
}
```

## Förord {#förord}

Denna rapport sammanfattar data från Vasaloppen mellan åren 2012 och 2016. **Främsta målet är att presentera mellantidsrekommendationer givet en önskad övre sluttid.** Det vill säga, att med hjälp av enkla samband ge vasaloppsåkare tidsintervall inom vilka de bör nå kontrollerna i Smågan, Mångsbodarna, Risberg, Evertsberg, Oxberg, Hökberg, och Eldris, om de vill nå Mora innan en viss sluttid. Dessa föreslagna mellantider presenteras i tabeller i [kapitel V](#v---mellantidsrekommendationer). 

Typiska hastighetsprofiler för vasaloppsåkare med närliggande sluttider har också tagits fram, i jämförelse med medelhastigheten för övriga åkare med liknande målgångstider. Utöver detta kommer jag även att försöka besvara bl.a. följande frågor:

* Vilka klubbar (med fler än 40 deltagare) har bäst snittider i respektive lopp? 
* Hur är sluttiderna fördelade från år till år, och från startgrupp till startgrupp?
* Vilka åldersgrupper har störst representation i startfältet? 
* Hur varierar medeltid i mål över åldersgrupperna? Mellan kvinnor och män?
* Kan man hitta några mönster eller avvikelser i skidåkarnas hastighet beroende på år och sluttid?

Denna rapport innehåller ingen granskning eller härledning av mellantidsrekommendationerna. Detta för att rapporten inte ska bli dubbelt så lång eller alltför svårläst för gemene skidåkare. Inom kort kommer jag dock lägga upp en andra version av rapporten (på samma github) som även innehåller härledningar, statistiska tester av mellantidsrekommendationerna, samt R-kod för att generera allt. Då kommer jag även att tillhandahålla något modifierade dataset för den som själv vill prova på att programmera.

Data har hämtats från den numera nedlagda sajten resultatjakt.se, och innehåller bland annat namn, klubbar, mellantider, och sluttider, på skidåkare som tagit sig i mål. All data som presenteras här har dock anonymiserats för att man inte ska kunna urskilja enskilda personers prestationer. Syftet med rapporten är inte heller att belysa enskilda åkares bedrifter, utan att ta fram statistik och hitta mönster hos större grupper av skidåkare, som t.ex. de med närliggande sluttider. 

*Notera att denna rapport inte kan kopplas till Vasaloppsarrangören på något sätt, den är framtagen helt på eget bevåg av undertecknad.*

#### Vem är jag?

Jag heter Olof Rännbäck-Garpinger och är en sportintresserad skåning, dock helt utan Vasaloppsmeriter. Längdskidor åker jag endast när det finns tillräckligt med snö i södra Sverige, och det händer tyvärr alltför sällan. Min yrkesmässiga bakgrund ligger inom ingenjörsyrket och jag är reglerteknisk specialist. Sedan 2016 brinner jag för Data Science (<https://en.wikipedia.org/wiki/Data_science>), och denna rapport är en del av mitt lärande inom ämnet. Mina Vasaloppsstudier började först som ett hobbyprojekt, men har sedan övergått till ett mindre projekt på arbetet. 

#### Programmering

Rapporten har skrivits i R Markdown där figurer och tabeller har genererats med hjälp av R-kod. R är ett programmeringsspråk som används för t.ex. statistiska analyser, beräkningar, datahantering, visualiseringar, och maskininlärning. 

#### English please?

This report explores data from Vasaloppet from 2012 to 2016. It is part of the author's learning project in Data Science. So far, there are no plans to translate the report to English, but this could change if there is enough interest for it. So, if you wish that I translate the report, please send me an e-mail (olof.rannbackgarpinger@knightec.se) with a translation request.

#### Tack!
Jag skulle vilja rikta ett stort tack till Erik Hallengren som har gett mig såväl inspiration till detta arbete, som tillgång till data. 

Jag vill också tacka min arbetsgivare Knightec AB, samt min chef Viveca Selander, för att jag fått möjlighet att lära mig mer om R och jobba med denna rapport.

Sist men inte minst är jag mycket tacksam över att mina kollegor Josefin Berner, Jonas Dürango, och Pierre Landén hjälpt mig med feedback, samt att färdigställa rapporten.

## Innehållsförteckning {#innehållsförteckning}

[Förord](#förord)

[I - Vasaloppsdata](#i---vasaloppsdata)

[II - Mellantider och sluttider från år till år](#ii---mellantider-och-sluttider-från-år-till-år)

[III - Sammanställning av klubbars medeltider i mål](#iii---sammanställning-av-klubbars-medeltider-i-mål)

[IV - Medeltider för skidåkare i olika åldersklasser](#iv---medeltider-för-skidåkare-i-olika-åldersklasser)

[V - Mellantidsrekommendationer](#v---mellantidsrekommendationer)

[VI - Hastigheter för skidåkare med liknande tid i mål](#vi---hastigheter-för-skidåkare-med-liknande-tid-i-mål)

## I - Vasaloppsdata {#i---vasaloppsdata}

Data från samtliga Vasalopp mellan 2012 och 2016 finns lagrade i csv-filer, vilket i princip betyder att den ligger sparad i fem stycken tabeller. En rad i data anger en enskild skidåkares personuppgifter (namn, klubb, startnummer, etc.) och prestation (mellantider och sluttid). Samtliga uppifter som skulle kunna peka ut enskild skidåkare har dock anonymiserats i denna rapport då jag endast är intresserad av titta på kollektiva mönster.    

```{r load_data, message = FALSE}
age_levels <- c("19-20","21","35","40","45","50","55","60","65","70","75","80-")
vl_2016 <- read_csv("vl_2016_tidy.csv", 
                    col_types = cols(start_group = col_factor(ordered = T, levels = 0:10),
                                     age_class = col_factor(ordered = T, age_levels),
                                     gender = col_factor(levels = c("M","F")),
                                     time_grp_mora = col_factor(ordered = T, levels = 1:39)
                    ))

vl_2012_x <- read_csv("vl_2012_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2013_x <- read_csv("vl_2013_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2014_x <- read_csv("vl_2014_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2015_x <- read_csv("vl_2015_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2016_x <- read_csv("vl_2016_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vasalopp_alla_tider <- vl_2012_x %>% 
  bind_rows(vl_2013_x, vl_2014_x, vl_2015_x, vl_2016_x)

paces_2012 <- avg_paces_and_ranks(vl_2012_x, 2012)
paces_2013 <- avg_paces_and_ranks(vl_2013_x, 2013)
paces_2014 <- avg_paces_and_ranks(vl_2014_x, 2014)
paces_2015 <- avg_paces_and_ranks(vl_2015_x, 2015)
paces_2016 <- avg_paces_and_ranks(vl_2016_x, 2016)

checkpoint_levels <- c("smagan", "mangsbodarna", "risberg", "evertsberg", 
                       "oxberg", "hokberg", "eldris", "mora")

all_avg_paces <- paces_2012 %>% 
  bind_rows(paces_2013, paces_2014, paces_2015, paces_2016) %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels))
```

Samtliga datafiler innehåller tillsammans information om `r nrow(vl_2012_x) + nrow(vl_2013_x) + nrow(vl_2014_x) + nrow(vl_2015_x) + nrow(vl_2016_x)` stycken Vasaloppsbedrifter (där vissa åkare återkommer från år till år). Varje dataset innehåller skidåkar-ID, Vasaloppsår, mellantider och sluttider i sekunder, det vill säga som i tabellen här nedan. Endast skidlöpare som gått i mål är med i data.

```{r time_data}
set.seed(1)
knitr::kable(vl_2012_x %>% 
               slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>% 
               select(event_year, smagan:mora) %>% 
               mutate(Skidåkare = c(1,2,3,4,5),
                      smagan = smagan+sample(seq(-100, 100, 1),5, replace = T),
                      mangsbodarna = mangsbodarna+sample(seq(-100, 100, 1),5, replace = T),
                      risberg = risberg+sample(seq(-100, 100, 1),5, replace = T),
                      evertsberg = evertsberg+sample(seq(-100, 100, 1),5, replace = T),
                      oxberg = oxberg+sample(seq(-100, 100, 1),5, replace = T),
                      hokberg = hokberg+sample(seq(-100, 100, 1),5, replace = T),
                      eldris = eldris+sample(seq(-100, 100, 1),5, replace = T),
                      mora = mora+sample(seq(-100, 100, 1),5, replace = T)) %>% 
               rename(År = event_year,
                       `Smågan (sek)` = smagan,
                       `Mångsbodarna (sek)` = mangsbodarna,
                       `Risberg (sek)` = risberg,
                       `Evertsberg (sek)` = evertsberg,
                       `Oxberg (sek)` = oxberg,
                       `Hökberg (sek)` = hokberg,
                       `Eldris (sek)` = eldris,
                       `Mora (sek)` = mora) %>% 
               select(Skidåkare, everything()))
```

Om man beräknar tidsdifferensen mellan varje kontroll och lägger till uppgifter om avståndet mellan de olika kontrollerna kan man även få ut skidåkarnas fart mellan varje kontroll. I nästa tabell visas denna information (i km/h). Fart till *kontrollens namn* (exempelvis Smågan) relaterar till hastigheten mellan föregående kontroll och denna kontrollstation (t.ex. start till Smågan). 

```{r paces_data}
set.seed(5)
knitr::kable(vl_2012_x %>% 
  slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>%              
  select(event_year, smagan_pace:mora_pace) %>%
  mutate(Skidåkare = c(6,7,8,9,10),
    smagan_pace = smagan_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      mangsbodarna_pace = mangsbodarna_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      risberg_pace = risberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      evertsberg_pace = evertsberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      oxberg_pace = oxberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      hokberg_pace = hokberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      eldris_pace = eldris_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      mora_pace = mora_pace+sample(seq(-1, 1, 0.01),5, replace = T)) %>%
  rename(År = event_year,
         `Fart till Smågan (km/h)` = smagan_pace,
         `Fart till Mångsbodarna (km/h)` = mangsbodarna_pace,
         `Fart till Risberg (km/h)` = risberg_pace,
         `Fart till Evertsberg (km/h)` = evertsberg_pace,
         `Fart till Oxberg (km/h)` = oxberg_pace,
         `Fart till Hökberg (km/h)` = hokberg_pace,
         `Fart till Eldris (km/h)` = eldris_pace,
         `Fart till Mora (km/h)` = mora_pace) %>% 
  select(Skidåkare, everything())) 
```

Sluttiderna (alltså tiderna i Mora) har även delats in i ett antal tidsgrupper om 15 minuter mellan varje. En grupp är t.ex. den med sluttider mellan 06:45:00 (timmar, minuter, sekunder) och 07:00:00. Denna grupp kommer jag fortsättningvis kalla gruppen som är i mål innan 07:00:00, t.ex. i mellantidsrekommenderingen i [kapitel V](#v---mellantidsrekommendationer). 

I data från 2016 finns även uppgifter om genus (Man/Kvinna), åldersgrupp (12 grupper: 19-20, 21, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80-), och startgrupp (11 grupper från 0-10, där 0 är högst rankat och 10 är lägst rankat). Om jag tolkat åldersgrupperna korrekt så innehåller t.ex. grupp 21 alla åkare mellan 21 och 34 år, och så vidare. 

```{r 2016_specific_data}
set.seed(9)
knitr::kable(vl_2016 %>% 
  slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>%
  select(event_year, gender, age_class, start_group) %>% 
  mutate(Skidåkare = c(1,2,3,4,5),
         gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  rename(År = event_year,
         Genus = gender,
         Åldersklass = age_class,
         Startgrupp = start_group) %>% 
  select(Skidåkare, everything()))
```

Dessa uppgifter används nedan för att göra en lite mer utförlig analys av 2016 års data. Dessutom kan man beräkna hur mycket snabbare eller långsammare en skidåkare har åkt relativt övriga åkare i samma startgrupp. D.v.s. avgöra hur väl de har åkt jämfört med andra åkare som har liknande ambitionsnivå. Denna information har använts för att analysera mönster i skidåkarnas hastighetsprofiler (se [kapitel VI](#vi---hastigheter-för-skidåkare-med-liknande-tid-i-mål)).

[Åter till innehållsförteckningen](#innehållsförteckning)

## II - Mellantider och sluttider från år till år {#ii---mellantider-och-sluttider-från-år-till-år}

Tabellen nedan innehåller uppgifter om hur medeltider vid varje kontroll och mål (i Mora) har varierat från år till år (i timmar:minuter:sekunder). Notera att endast skidåkare som tagit sig i mål funnits med i dessa uträkningar.

```{r avg_times_year}
median_times_all_years <- vasalopp_alla_tider %>% 
  group_by(event_year) %>% 
  summarize(`Smågan (sek)` = secs_to_time(median(smagan, na.rm = T)),
            `Mångsbodarna (sek)` = secs_to_time(median(mangsbodarna, na.rm = T)),
            `Risberg (sek)` = secs_to_time(median(risberg, na.rm = T)),
            `Evertsberg (sek)` = secs_to_time(median(evertsberg, na.rm = T)),
            `Oxberg (sek)` = secs_to_time(median(oxberg, na.rm = T)),
            `Hökberg (sek)` = secs_to_time(median(hokberg, na.rm = T)),
            `Eldris (sek)` = secs_to_time(median(eldris, na.rm = T)),
            `Mora (sek)` = secs_to_time(median(mora, na.rm = T))) %>% 
  rename(År = event_year)

# Tabell
knitr::kable(median_times_all_years)
```

2012 års Vasalopp var således det snabbaste av de fem, faktiskt ända från Smågan till mål. Vasaloppet 2015 var långsammast och det verkar främst ha berott på förhållandena efter Risberg. 

Figuren nedan visar hur många skidåkare som varje år gått i mål inom respektive 15-minutersintervall. Här ser vi t.ex. hur det 2012 var ovanligt många skidåkare med tider mellan 5 och 8 timmar. 2015 var det å andra sidan väldigt få som gick i mål innan 5-timmarsstrecket. En annan intressant detalj är att 2016 års fördelning har en rejäl topp strax innan 10 timmar. Frågan är vad det kan har berott på? Låt oss återkomma till detta längre fram i rapporten.

```{r skiiers_mora_15_min_intervals_all_years}
vasalopp_alla_tider %>% 
  mutate(mora = secs_to_time(mora)) %>% 
  ggplot(aes(mora, col = event_year)) +
  geom_freqpoly(binwidth = 900, lwd = 1.5) +
  labs(x = "Tid i mål",
       y = "Antal skidåkare som går i mål inom 15-minutersintervall") +
  scale_color_discrete("År")
```

Nästa figur visar antalet skidåkare inom varje startgrupp som kommit i mål inom respektive 15-minutersintervall under 2016 års Vasalopp. Lägre startgrupper är mer välsamlade än de högre, vilket tyder på en mer samlad prestationsnivå hos de åkarna. Grupperna 8-10 har alla samma tydliga spik innan 10 timmar, som även syntes i föregående figur. Startgrupp 10 har för övrigt den klart största spridningen i sluttider, och man märker att många av skidlöparna i denna grupp egentligen borde ha tillhört en något lägre startgrupp. Gissningsvis de som inte ville eller hade möjlighet att få en bättre seedning.  

```{r skiiers_mora_15_min_intervals_all_start_groups_2016}
vl_2016 %>% 
  filter(!is.na(start_group)) %>% 
  mutate(mora = secs_to_time(mora)) %>% 
  ggplot(aes(mora,col = start_group)) + 
  geom_freqpoly(binwidth = 600, lwd = 1.5) +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Tid i mål",
       y = "Antal skidåkare som går i mål inom 15-minutersintervall") +
  scale_color_discrete("Startgrupp")
```

[Åter till innehållsförteckningen](#innehållsförteckning)

## III - Sammanställning av klubbars medeltider i mål {#iii---sammanställning-av-klubbars-medeltider-i-mål}

Data innehåller samtliga skidåkares klubbtillhörighet, och jag har därför valt att beräkna medeltider i mål för samtliga klubbar med fler än 40 deltagare i de enskilda loppen. Att gränsen dragits vid just 40 deltagare beror på att jag velat begränsa antalet klubbar i de fem figurerna nedan, som visar medeltiderna för varje klubb. I figurerna kan man se att klubbar från södra Sverige (som t.ex. Lugi SK, och IFK Helsingborg) och klubbar med företagsnamn (som Volvo IF, IBM-klubben, etc.) typiskt har lite sämre medeltider i mål. Exempel på prominenta klubbar är Borås SK, Östersunds skidlöpareklubb, IKJ Haninge, Sundbybergs IK, Karlslunds IF SF, och IFK Mora SK. Överlag är det många storstadsklubbar representerade, vilket inte är så oväntat.

```{r clubs_2012}
# Medeltid i Mora för klubbar med fler än 50 åkare
vl_2012_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2012") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare i mål") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2013}
vl_2013_x %>% 
  mutate(club = as.factor(club)) %>% 
  filter((club != "Norge") & (club != "Norway")) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2013") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare i mål") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2014}
vl_2014_x %>% 
  filter((club != "Norge") & (club != "Norway") & (club != "Germany")) %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2014") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare i mål") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2015}
vl_2015_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2015") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare i mål") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:32:00")))
```

```{r clubs_2016}
vl_2016_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare i mål") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

[Åter till innehållsförteckningen](#innehållsförteckning)

## IV - Medeltider för skidåkare i olika åldersklasser {#iv---medeltider-för-skidåkare-i-olika-åldersklasser}

Låt oss nu ta en titt på hur åldersfördelningen såg ut bland de som tog sig i mål i Vasaloppet 2016. Figuren nedan visar antalet skidlöpare i varje klass delat med antalet år åldersklassen spänner över. Åldersklassen *21* hade t.ex. 3676 skidlöpare som tog sig ända fram till Mora. Eftersom klassen spänner över 14 år (från 21-åringar till 34-åringar) så blir antalet skidåkare per antalet år i åldersklassen lika med $3676/14 = 262.6$ stycken. Anledningen till denna indelning är att vissa åldersklasser spänner fler år än andra. Åldersklassen *80-* har jag för enkelhetens skull antagit spänna över 5 år, precis som de flesta övriga klasser.

Intressant nog kan man notera att det är flest deltagare i åldern 40-44 år. Är detta månne ett tecken på 40-årskris hos en del vasaloppsåkare? :-) 

```{r ageclasses_histogram_2016}
vl_2016 %>% 
  filter(!is.na(age_class)) %>% 
  count(age_class) %>% 
  mutate(n = ifelse(age_class == 21, n/14, n/5)) %>% 
  mutate(n = ifelse(age_class == "19-20", n*5/2, n)) %>% 
  ggplot(aes(age_class, n)) +
  geom_bar(stat = "identity") +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Åldersklass",
       y = "Antal skidåkare i varje klass per antal år i klass")
```

I nästa figur är åldersgrupperna även uppdelade mellan män och kvinnor. Dels kan man se att det är klart färre kvinnor som ställt upp, samt att de är mer jämnt fördelade över åldrarna 21 till 54 år.  

```{r ageclasses_gender_histogram_2016}
vl_2016 %>% 
  mutate(gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  filter(!is.na(age_class)) %>% 
  group_by(age_class, gender) %>% 
  count(age_class) %>% 
  mutate(n = ifelse(age_class == 21, n/14, n/5)) %>% 
  mutate(n = ifelse(age_class == "19-20", n*5/2, n)) %>% 
  ggplot(aes(age_class, n, group = gender, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Åldersklass",
       y = "Antal skidåkare i varje klass per antal år i klass") +
  scale_fill_discrete("Genus")
```

Om man sammanställer medeltiderna för respektive åldersgrupp kan man också se att *40*-gruppen inte bara är den mest välrepresenterade gruppen, utan även har den bästa medeltiden av alla. Då ska man emellertid komma ihåg att det är många duktiga yngre skidåkare som fokuserar på världscupen snarare än långlopp som Vasaloppet. 

För övrigt kan man notera att det är först efter 60 år som åldern på allvar tycks börja sätta begränsningar för hur snabbt man åker.

```{r ageclasses_avgmoratime_2016}
vl_2016 %>% 
  group_by(age_class) %>% 
  summarize(avg_mora = mean(mora), count = n()) %>% 
  na.omit() %>% 
  mutate(avg_mora = secs_to_time(avg_mora)) %>% 
  ggplot(aes(age_class, avg_mora, group = 1)) +
  geom_line(lwd = 1.5) +
  ggtitle("Vasaloppet 2016") +
  scale_y_time(breaks=parse_time(c("07:30:00","08:00:00","08:30:00","09:00:00","09:30:00","10:00:00"))) +
  labs(x = "Åldersklass",
       y = "Medeltid i mål")
```

I nästa figur är medeltiderna även uppdelade efter kön. I snitt låg kvinnorna kring 1 timme och 40 minuter efter männen i samma åldersklasser. 

```{r ageclasses_gender_avgmoratime_2016}
vl_2016 %>% 
  mutate(gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  group_by(gender, age_class) %>% 
  summarize(avg_mora = mean(mora),
            count = n()) %>%
  mutate(avg_mora = secs_to_time(avg_mora)) %>% 
  na.omit() %>% 
  ggplot(aes(age_class, avg_mora)) +
  geom_line(aes(group = gender, col = gender), lwd = 1.5) +
  scale_y_time(breaks=parse_time(c("07:30:00","08:00:00","08:30:00","09:00:00","09:30:00","10:00:00", "10:30:00")),
               limits = parse_time(c("07:27:00","10:30:00"))) +
  labs(x = "Åldersklass",
       y = "Medeltid i mål") +
  ggtitle("Vasaloppet 2016") +
  scale_color_discrete("Genus") 
```

Generellt sett ska man dock passa sig för att dra alltför långtgående slutsatser utifrån endast ett års Vasalopp (eller fem för den delen). Det kan finnas variationer mellan åren som man inte har information om. 

[Åter till innehållsförteckningen](#innehållsförteckning)

## V - Mellantidsrekommendationer {#v---mellantidsrekommendationer}
```{r mora_grp_time}
mora_seqs <- seq(12600,47700,15*60)
jj <- 1
mora_grp_time <- vector(mode = "character",length(7:31))
for (ii in mora_seqs[7:31]) {
  mora_grp_time[jj] <- as.character(secs_to_time(ii))
  jj <- jj+1
}
mora_grp_time <- parse_time(mora_grp_time)
```

```{r timerec_noanalysis, include = FALSE}
vasalopp_alla_tider_mod <- vasalopp_alla_tider
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "smagan"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "mangsbodarna"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "risberg"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2016, "oxberg"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2016, "hokberg"] = NA

time_recommender <- vasalopp_alla_tider_mod %>%
  group_by(time_grp_mora) %>%
  summarize(smagan_1 = secs_to_time(quantile(smagan, 0.125, na.rm = T)),
            smagan_2 = secs_to_time(median(smagan, na.rm = T)),
            smagan_3 = secs_to_time(quantile(smagan, 0.875, na.rm = T)),
            mangsbodarna_1 = secs_to_time(quantile(mangsbodarna, 0.125, na.rm = T)),
            mangsbodarna_2 = secs_to_time(median(mangsbodarna, na.rm = T)),
            mangsbodarna_3 = secs_to_time(quantile(mangsbodarna, 0.875, na.rm = T)),
            risberg_1 = secs_to_time(quantile(risberg, 0.125, na.rm = T)),
            risberg_2 = secs_to_time(median(risberg, na.rm = T)),
            risberg_3 = secs_to_time(quantile(risberg, 0.875, na.rm = T)),
            evertsberg_1 = secs_to_time(quantile(evertsberg, 0.125, na.rm = T)),
            evertsberg_2 = secs_to_time(median(evertsberg, na.rm = T)),
            evertsberg_3 = secs_to_time(quantile(evertsberg, 0.875, na.rm = T)),
            oxberg_1 = secs_to_time(quantile(oxberg, 0.125, na.rm = T)),
            oxberg_2 = secs_to_time(median(oxberg, na.rm = T)),
            oxberg_3 = secs_to_time(quantile(oxberg, 0.875, na.rm = T)),
            hokberg_1 = secs_to_time(quantile(hokberg, 0.125, na.rm = T)),
            hokberg_2 = secs_to_time(median(hokberg, na.rm = T)),
            hokberg_3 = secs_to_time(quantile(hokberg, 0.875, na.rm = T)),
            eldris_1 = secs_to_time(quantile(eldris, 0.125, na.rm = T)),
            eldris_2 = secs_to_time(median(eldris, na.rm = T)),
            eldris_3 = secs_to_time(quantile(eldris, 0.875, na.rm = T))) %>% 
  filter(between(as.numeric(time_grp_mora),7, 31))

for(ii in 1:length(mora_grp_time)) {
  tmp <- time_recommender %>% 
    select(-time_grp_mora) %>% 
    slice(ii)
  name <- paste0("table_", mora_grp_time[ii])
  assign(name, tibble(Kontroll = c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg",
                                   "Oxberg", "Hökberg", "Eldris"),
                      "Undre tid"=c(tmp[[1]],tmp[[4]],tmp[[7]],tmp[[10]],tmp[[13]],tmp[[16]],tmp[[19]]),
                      "Rekommenderad tid"=c(tmp[[2]],tmp[[5]],tmp[[8]],tmp[[11]],tmp[[14]],tmp[[17]],tmp[[20]]),
                      "Övre tid"=c(tmp[[3]],tmp[[6]],tmp[[9]],tmp[[12]],tmp[[15]],tmp[[18]],tmp[[21]])) %>% 
           mutate(Tidsfönster = secs_to_time(as.integer(`Övre tid`-`Undre tid`))))
}
```

I detta kapitel ges rekommendationer på lämpliga mellantider givet en viss önskad tid i mål. Rekommendationstabellerna nedan kan även användas för att, givet en viss mellantid, hitta andra lämpliga mellantider och sluttid att sikta in sig på. På så vis kan man få tips om hur man bäst lägger upp sitt resterande lopp. 

I tabellerna anges en övre gräns för sluttiden ovanför tabellen. Antag t.ex. att det står *I mål innan 07:00:00*. Då gäller tabellen skidåkare som önskar ta sig i mål mellan 06:45:00 och 07:00:00. Första kolonnen i tabellen anger vilken kontroll det rör sig om. *Rekommenderad tid* anger den tid då skidåkaren rekommenderas ankomma till kontrollen. Denna har härletts genom att ta mediantiden för skidåkare med liknande tid i mål. *Undre tid* och *Övre tid* har valts så att de rymmer ungefär 75% av alla skidlöpares tider (av de som har samma sluttid). *Tidsfönster* är skillnaden mellan övre och undre tid.

Sluttiderna i tabellerna nedan sträcker sig mellan 05:00:00 och 11:00:00. Dessa gränser har valts därför att det är någorlunda många åkare (över de här fem åren) som har tagit sig i mål mellan dessa tider. Övriga sluttider är helt enkelt inte lika välrepresenterade i data. 

För att få en överblick kan man rita ut de rekommenderade tiderna vid respektive kontroll, mot sluttiderna. Då får man figuren här nedan. Rekommenderade tider ges av heldragna linjer, undre och övre tider av streckade linjer. Så genom att se vilken sluttid man vill ha kan man gå in och läsa av i figuren inom vilka tidsintervall man bör vara vid respektive kontroll. Vill man ha noggrannare siffror än vad som går att läsa av i figuren får man titta i tabellerna nedan.

```{r time_recommender_interval_plot}
time_recommender %>% 
  ggplot(aes(y = mora_grp_time, x = smagan_2)) +
  geom_line(aes(col = "1. Smågan"), lwd = 1.5) +
  geom_line(aes(x = smagan_1, col = "1. Smågan"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = smagan_3, col = "1. Smågan"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_2, col = "2. Mångsbodarna"), lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_1, col = "2. Mångsbodarna"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_3, col = "2. Mångsbodarna"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = risberg_2, col = "3. Risberg"), lwd = 1.5) +
  geom_line(aes(x = risberg_1, col = "3. Risberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = risberg_3, col = "3. Risberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = evertsberg_2, col = "4. Evertsberg"), lwd = 1.5) +
  geom_line(aes(x = evertsberg_1, col = "4. Evertsberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = evertsberg_3, col = "4. Evertsberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = oxberg_2, col = "5. Oxberg"), lwd = 1.5) +
  geom_line(aes(x = oxberg_1, col = "5. Oxberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = oxberg_3, col = "5. Oxberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = hokberg_2, col = "6. Hökberg"), lwd = 1.5) +
  geom_line(aes(x = hokberg_1, col = "6. Hökberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = hokberg_3, col = "6. Hökberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = eldris_2, col = "7. Eldris"), lwd = 1.5) +
  geom_line(aes(x = eldris_1, col = "7. Eldris"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = eldris_3, col = "7. Eldris"),lty = 2, lwd = 1.5) + 
  scale_color_discrete(name="") +
  xlab("Tid vid kontroll") +
  ylab("Tid i mål") + 
  theme(legend.position = "top")
```

Om man granskar mellantiderna från år till år lite noggrannare kan man se att det kan variera en del vilka tider skidlöparna kommer in till kontrollerna, trots att de sedan får samma sluttider. Detta beror sannolikt på andra faktorer såsom vädret före och under loppet. Det är således inte hela världen ifall man missar något eller några tidsintervall. Faktum är att fler än 60% missar åtminstone ett intervall. Granskningen visar även att ungefär 75% av skidlöparna med en viss sluttid prickar in det uppritade tidsintervallet vid åtminstone fyra av sju kontroller. Missar man fler än så och ändå når sluttiden så kan man fråga sig själv ifall man verkligen har disponerat sitt lopp på bästa sätt.

**Notera att rekommendationstabellerna är härledda för riktiga Vasaloppet. De har inte testats på data från t.ex. öppet spår.**

#### I mål innan *05:00:00*
```{r 0500}
knitr::kable(
  `table_05:00:00`
)
```

#### I mål innan *05:15:00*
```{r 0515}
knitr::kable(
  `table_05:15:00`
)
```

#### I mål innan *05:30:00*
```{r 0530}
knitr::kable(
  `table_05:30:00`
)
```

#### I mål innan *05:45:00*
```{r 0545}
knitr::kable(
  `table_05:45:00`
)
```

#### I mål innan *06:00:00*
```{r 0600}
knitr::kable(
  `table_06:00:00`
)
```

#### I mål innan *06:15:00*
```{r 0615}
knitr::kable(
  `table_06:15:00`
)
```

#### I mål innan *06:30:00*
```{r 0630}
knitr::kable(
  `table_06:30:00`
)
```

#### I mål innan *06:45:00*
```{r 0645}
knitr::kable(
  `table_06:45:00`
)
```

#### I mål innan *07:00:00*
```{r 0700}
knitr::kable(
  `table_07:00:00`
)
```

#### I mål innan *07:15:00*
```{r 0715}
knitr::kable(
  `table_07:15:00`
)
```

#### I mål innan *07:30:00*
```{r 0730}
knitr::kable(
  `table_07:30:00`
)
```

#### I mål innan *07:45:00*
```{r 0745}
knitr::kable(
  `table_07:45:00`
)
```

#### I mål innan *08:00:00*
```{r 0800}
knitr::kable(
  `table_08:00:00`
)
```

#### I mål innan *08:15:00*
```{r 0815}
knitr::kable(
  `table_08:15:00`
)
```

#### I mål innan *08:30:00*
```{r 0830}
knitr::kable(
  `table_08:30:00`
)
```

#### I mål innan *08:45:00*
```{r 0845}
knitr::kable(
  `table_08:45:00`
)
```

#### I mål innan *09:00:00*
```{r 0900}
knitr::kable(
  `table_09:00:00`
)
```

#### I mål innan *09:15:00*
```{r 0915}
knitr::kable(
  `table_09:15:00`
)
```

#### I mål innan *09:30:00*
```{r 0930}
knitr::kable(
  `table_09:30:00`
)
```

#### I mål innan *09:45:00*
```{r 0945}
knitr::kable(
  `table_09:45:00`
)
```

#### I mål innan *10:00:00*
```{r 1000}
knitr::kable(
  `table_10:00:00`
)
```

#### I mål innan *10:15:00*
```{r 1015}
knitr::kable(
  `table_10:15:00`
)
```

#### I mål innan *10:30:00*
```{r 1030}
knitr::kable(
  `table_10:30:00`
)
```

#### I mål innan *10:45:00*
```{r 1045}
knitr::kable(
  `table_10:45:00`
)
```

#### I mål innan *11:00:00*
```{r 1100}
knitr::kable(
  `table_11:00:00`
)
```

[Åter till innehållsförteckningen](#innehållsförteckning)

## VI - Hastigheter för skidåkare med liknande tid i mål {#vi---hastigheter-för-skidåkare-med-liknande-tid-i-mål}

Detta kapitel innehåller lite mer avancerad analys. Vi kommer titta lite mer på hur hastigheterna har varierat från år till år på de olika delsträckorna, och analysera hastighetsprofiler över hela banan. Tabellen nedan sammanställer medelfarten (i km/h) för samtliga delsträckor. De snabbaste sträckorna sett till alla år är: Smågan-Mångsbodarna, Mångsbodarna-Risberg, och Evertsberg-Oxberg. Klart långsammaste sträckan är start till Smågan, men det är inte så konstigt med tanke på stigningen upp till Smågan, samt den köbildning som uppstår där när tusentals åkare trängs om ett fåtal spår.

```{r avg_paces_all_controls_all_years}
mean_paces_years <- vasalopp_alla_tider %>% 
  group_by(event_year) %>% 
  summarize(`Fart till Smågan (km/h)` = round(mean(smagan_pace, na.rm = T),1),
            `Fart till Mångsbodarna (km/h)` = round(mean(mangsbodarna_pace, na.rm = T),1),
            `Fart till Risberg (km/h)` = round(mean(risberg_pace, na.rm = T),1),
            `Fart till Evertsberg (km/h)` = round(mean(evertsberg_pace, na.rm = T),1),
            `Fart till Oxberg (km/h)` = round(mean(oxberg_pace, na.rm = T),1),
            `Fart till Hökberg (km/h)` = round(mean(hokberg_pace, na.rm = T),1),
            `Fart till Eldris (km/h)` = round(mean(eldris_pace, na.rm = T),1),
            `Fart till Mora (km/h)` = round(mean(mora_pace, na.rm = T),1)) %>% 
  rename(År = event_year)

knitr::kable(mean_paces_years)
```

```{r mora_grp_time2, message = F}
mora_seqs <- seq(12600,47700,15*60)
jj <- 1
mora_grp_time2 <- vector(mode = "character",length(3:35))
for (ii in mora_seqs[3:35]) {
  mora_grp_time2[jj] <- as.character(secs_to_time(ii))
  jj <- jj+1
}
mora_grp_time2 <- parse_time(mora_grp_time2)
```

```{r avgpaces_all_timegrpsmora_all_controls_all_years_creating_tibbles}
paces_2012_startgrupper <- vl_2012_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2012) %>% 
  select(event_year, everything())

paces_2013_startgrupper <- vl_2013_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2013) %>% 
  select(event_year, everything()) 

paces_2014_startgrupper <- vl_2014_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2014) %>% 
  select(event_year, everything()) 

paces_2015_startgrupper <- vl_2015_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2015) %>% 
  select(event_year, everything()) 

paces_2016_startgrupper <- vl_2016_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2016) %>% 
  select(event_year, everything())
```

Härnäst kommer vi att titta på medelhastigheter för skidåkare med liknande tider i mål (se [kapitel I](#i---vasaloppsdata) för förklaring till hur åkarna delades in i tidsgrupper). Första bilden här nedan visar hur medelhastigheten berodde av sluttiden under 2012 års Vasalopp. Dels kan man se att hastigheten mellan start och Smågan avtar snabbare än övriga kurvor med hänsyn till sluttid. Det antyder att det bara är de allra bästa åkarna som knappt påverkas av köbildningen vid start. En annan intressant tendens är den att hastigheterna avtog så markant mellan Mångsbodarna och Risberg för åkare med sluttid mellan 9 och 11 timmar. Min första gissning var att hastighetssänkningen kunde ha med följande vurpor att göra: <https://www.youtube.com/watch?v=LohiNobXNs0>. Men en mer insatt källa har berättat att denna backe kommer först efter Risberg, och skulle därmed inte ha kunnat påverka hastigheterna på sträckan fram till Risberg.

```{r avg_time_timegrpsmora_all_controls_2012}
paces_2012_startgrupper %>% 
  ggplot(aes(mora_grp_time2,smagan_pace_mean)) +
  geom_line(aes(col="1. Smågan"),lwd = 1.5) +
  geom_line(aes(y = mangsbodarna_pace_mean, col="2. Mångsbodarna"),lwd = 1.5) +
  geom_line(aes(y = risberg_pace_mean, col="3. Risberg"),lwd = 1.5) +
  geom_line(aes(y = evertsberg_pace_mean, col="4. Evertsberg"),lwd = 1.5) +
  geom_line(aes(y = oxberg_pace_mean, col="5. Oxberg"),lwd = 1.5) +
  geom_line(aes(y = hokberg_pace_mean, col="6. Hökberg"),lwd = 1.5) +
  geom_line(aes(y = eldris_pace_mean, col="7. Eldris"),lwd = 1.5) +
  geom_line(aes(y = mora_pace_mean, col="8. Mora"),lwd = 1.5) +
  scale_color_discrete("Kontroll") +
  ggtitle("Vasaloppet 2012") +
  labs(x = "Tid i Mora",
       y = "Medelfart (km/h) till kontroll")
```

Nästa figur visar samma hastighetskurvor för 2016. Intressant nog har skidåkare med sluttid strax innan 10 timmar högre fart från Hökberg till Mora än vad åkare med sluttid strax därinnan hade. Skulle det kunna vara så att 10-timmarsstrecket är så hägrande att många skidlöpare tar ut sig lite extra bara för att nå fram innan detta? Det skulle också förklara varför det var så många som hade en sluttid strax under 10 timmar i just detta loppet.

```{r avg_time_timegrpsmora_all_controls_2016}
paces_2016_startgrupper %>% 
  ggplot(aes(mora_grp_time2,smagan_pace_mean)) +
  geom_line(aes(col="1. Smågan"),lwd = 1.5) +
  geom_line(aes(y = mangsbodarna_pace_mean, col="2. Mångsbodarna"),lwd = 1.5) +
  geom_line(aes(y = risberg_pace_mean, col="3. Risberg"),lwd = 1.5) +
  geom_line(aes(y = evertsberg_pace_mean, col="4. Evertsberg"),lwd = 1.5) +
  geom_line(aes(y = oxberg_pace_mean, col="5. Oxberg"),lwd = 1.5) +
  geom_line(aes(y = hokberg_pace_mean, col="6. Hökberg"),lwd = 1.5) +
  geom_line(aes(y = eldris_pace_mean, col="7. Eldris"),lwd = 1.5) +
  geom_line(aes(y = mora_pace_mean, col="8. Mora"),lwd = 1.5) +
  scale_color_discrete("Kontroll") +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Tid i Mora",
       y = "Medelfart (km/h) till kontroll")
```

Låt oss slutligen undersöka ifall några av de udda mönstren från föregående två figurer återkommer mer än ett år. Följande två figurer visar således hur medelfarten har varierat från år till år, för sträckorna Mångsbodarna-Risberg och Eldris-Mora. I den första figuren kan vi se att hastighetssänkningen till Risberg endast förekom 2012. I den andra figuren ser vi tendenser till fartökningar för åkare som går i mål kring 10 timmar, även i 2014 och 2015 års lopp. Dessa är dock inte lika tydliga som den i 2016 års lopp. 

En annan intressant observation är att 2016 års kurva ligger klart under de övriga mellan Mångsbodarna och Risberg, men sedan ovanför de övriga mellan Eldris och Mora. Det antyder att många skidlöpare kunde åka på mot slutet.

```{r avgpaces_mangsbodarna_to_risberg_all_years}
checkpoint_levels3 <- c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg", "Oxberg", "Hökberg", "Eldris", "Mora")
paces_2012_startgrupper %>% 
  bind_rows(paces_2013_startgrupper, paces_2014_startgrupper, 
            paces_2015_startgrupper, paces_2016_startgrupper) %>% 
  rename(Smågan = smagan_pace_mean,
         Mångsbodarna = mangsbodarna_pace_mean,
         Risberg = risberg_pace_mean,
         Evertsberg = evertsberg_pace_mean,
         Oxberg = oxberg_pace_mean,
         Hökberg = hokberg_pace_mean,
         Eldris = eldris_pace_mean,
         Mora = mora_pace_mean) %>% 
  mutate(event_year = as.ordered(event_year)) %>% 
  gather(Smågan:Mora, key = "checkpoint", value = "mean_pace") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels3)) %>% 
  filter((checkpoint == "Risberg")) %>% 
  ggplot(aes(mora_grp_time2, mean_pace, group = event_year, col = event_year)) +
  geom_line(lwd = 1.2) +
  scale_color_discrete("År") +
  labs(x = "Tid i mål",
       y = "Medelfart (km/h)") +
  ggtitle("Medelfarter mellan Mångsbodarna och Risberg") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
```

```{r avgpaces_eldris_to_mora_all_years}
paces_2012_startgrupper %>% 
  bind_rows(paces_2013_startgrupper, paces_2014_startgrupper, 
            paces_2015_startgrupper, paces_2016_startgrupper) %>% 
  rename(Smågan = smagan_pace_mean,
         Mångsbodarna = mangsbodarna_pace_mean,
         Risberg = risberg_pace_mean,
         Evertsberg = evertsberg_pace_mean,
         Oxberg = oxberg_pace_mean,
         Hökberg = hokberg_pace_mean,
         Eldris = eldris_pace_mean,
         Mora = mora_pace_mean) %>% 
  mutate(event_year = as.ordered(event_year)) %>% 
  gather(Smågan:Mora, key = "checkpoint", value = "mean_pace") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels3)) %>% 
  filter((checkpoint == "Mora")) %>% 
  ggplot(aes(mora_grp_time2, mean_pace, group = event_year, col = event_year)) +
  geom_line(lwd = 1.2) +
  scale_color_discrete("År") +
  labs(x = "Tid i mål",
       y = "Medelfart (km/h)") +
  ggtitle("Medelfarter mellan Eldris och Mora") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
```

Nästa steg blir att titta på hastighetsprofiler sett över hela loppet. Lönar det sig att köra extra hårt vissa sträckor, eller är det kanske jämnt tempo som är den bästa melodin? Låt oss jämföra åkare som tagit sig i mål i stort sett samtidigt. Jag har därför normaliserat deras hastigheter utmed loppet genom att i varje sträcka dra bort medelfarten hos övriga åkare med ungefär samma sluttid. På så vis kan man se var de enskilda skidlöparna har kört på lite mer eller lite mindre jämfört med övriga som presterat lika väl. Därefter har jag applicerat en teknik som kallas principalkomponentanalys (<https://sv.wikipedia.org/wiki/Principalkomponentanalys>) på de normaliserade farterna. Denna metod hittar mer eller mindre representativa mönster i data. De första två principalkomponenterna förklarar drygt 50% av variationen i skidåkarnas hastighetsprofiler. 

Figuren nedan visar de två första principalkomponenterna uträknade med 2016 års data (övriga år ger i princip samma resultat), och är markerade i grönt och blått. Den första komponenten beskriver skidåkare som startar i högt tempo (positiv fart), och avslutar desto lugnare (negativ fart). Andra komponenten motsvarar skidåkare som först blir fördröjda i Smågan (negativ fart), därefter växlar upp (positiv fart), för att sedan avsluta lugnt (negativ fart). Det fina med principalkomponenterna är att de även kan användas för att beskriva någon som kör omvänt (t.ex. börjar lugnt och avslutar starkt). Tillsammans kan de två komponenterna också kombineras för att beskriva ytterligare ett antal hastighetsprofiler. 

```{r plot_PC1_PC2_loadings_and_preferred_pace_profile_2016}
w <- c(-0.82,0.572)
PC <- tibble(PC1 = c(0.464, 0.350, 0.0810, -0.174, -0.365, -0.437, -0.410, -0.366),
             PC2 = c(-0.256,0.275,0.646,0.557,0.243,-0.0216,-0.184,-0.195))
checkpoint_levels <- c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg", 
                        "Oxberg", "Hökberg", "Eldris", "Mora")
PC %>% 
  mutate(representative_pace = w[1]*PC1+w[2]*PC2,
         checkpoint = factor(checkpoint_levels, levels = checkpoint_levels)) %>% 
  select(checkpoint, PC1, PC2, representative_pace) %>% 
  ggplot(aes(checkpoint, PC1, group = 1)) +
  geom_line(aes(col = "Principalkomponent 1"), lwd = 1.2) +
  geom_line(aes(y = PC2, col = "Principalkomponent 2"), lwd = 1.2) +
  geom_line(aes(y = representative_pace, col = "Fördelaktig fartprofil för\nskidåkare med liknande tider i Mora"), lwd = 1.2) +
  scale_color_discrete("Fartprofiler") +
  xlab("Kontroll") +
  ylab("Normaliserad fart mellan kontroller") +
  ggtitle("Vasaloppet 2016") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

Om man jämför de båda hastighetsprofilerna (principalkomponenterna) med hur väl skidåkarna har presterat (jämfört med övriga i samma startgrupp), kan man dessutom räkna fram en hastighetsprofil som varit extra fördelaktig bland åkare som nått samma sluttid. Denna är markerad i rött i figuren. Denna strategi föreslår alltså att man åker lugnare till en början, som snabbast i mitten av loppet, och något lite lugnare in i mål. En förklaring till varför denna profil tycks vara så fördelaktig är säkert för att många skidåkare som avancerar i fältet tvingas hålla lägre tempo till en början (då de trängs med skidåkare som inte håller samma tempo som de själva). En närmare titt på data visar emellertid att hastighetsprofilen även är fördelaktig  för åkare som startar längre fram i fältet, och som knappast behöver trängas lika mycket som övriga skidlöpare. Ett par tips till Vasaloppsåkare med höga ambitioner skulle då vara att:

1. Spara på krafterna precis vid starten, och höj sedan gradvis tempot upp mot Risberg.
2. Åka seedningslopp för att på så sätt få starta i en lägre startgrupp.

[Åter till innehållsförteckningen](#innehållsförteckning)